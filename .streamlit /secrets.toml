def get_drive_service():
    """透過 secrets.toml 取得 Google Drive 連線權限"""
    try:
        # 1. 取得 Secrets 內容並轉為一般字典
        info = dict(st.secrets["gcp_service_account"])
        
        # 2. 【關鍵】處理私鑰中的換行符號問題
        # 有些系統會把 \n 讀成兩個字元，這行會把它修復成 PEM 格式認得的換行
        if "private_key" in info:
            info["private_key"] = info["private_key"].replace("\\n", "\n")
            
        # 3. 建立憑證
        credentials = service_account.Credentials.from_service_account_info(info)
        scoped_credentials = credentials.with_scopes(['https://www.googleapis.com/auth/drive.file'])
        
        return build('drive', 'v3', credentials=scoped_credentials)
    except Exception as e:
        st.error(f"⚠️ 連線失敗，請檢查金鑰格式: {e}")
        return None
